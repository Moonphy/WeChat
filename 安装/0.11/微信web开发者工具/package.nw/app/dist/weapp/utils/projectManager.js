"use strict";function init(){function e(){F.info("projectManager.js cleanProjects");for(var e in _)_[e].watcher&&_[e].watcher.close();_={}}function r(n){var i=n.hash;if(!_[i]){N.project=n,Object.keys(_).length>L&&e(),F.info("manager.js initProject projectid "+n.projectid);var o={};o.watcher=w.watch(n.projectpath,{ignored:[/node_modules/],ignoreInitial:!0,ignorePermissionErrors:!0,followSymlinks:!0,interval:1e3,binaryInterval:1e3}).on("all",function(e,r,i){var o=d.extname(r);R.whiteFileExtName[o]&&(r=d.relative(n.projectpath,r),t(n,e,r,i))}),o.watcher.on("error",function(t){t&&!O&&(F.error("projectManager.js obj.watcher error "+t.toString()),O=!0,e(),r(n))}),o.cache={},o.wxmlFileList=[],o.jsFileList=[],_[i]=o}}function t(e,r,t,o){var a=e.hash,c=_[a].cache;t=t.replace(/\\/g,"/"),"app.json"===t&&(_[a].cache={}),t&&c[t]&&delete c[t];var s=d.extname(t);".wxml"===s?(clearTimeout(h),_[a].wxmlFileList=[],h=setTimeout(function(){n(e)},20)):".js"===s&&(clearTimeout(f),_[a].jsFileList=[],f=setTimeout(function(){i(e)},20)),N.fileChange(e,r,t,o)}function n(e,r){try{var t=m.sync("./**/*.wxml",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"]}),n=e.hash;_[n].wxmlFileList=t,r&&r(null,t)}catch(i){F.error("projectManager.js findAllWXMLFiles "+i.toString()),r&&r(error,[])}}function i(e,r){try{var t=m.sync("**/*.js",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"]}),n=e.hash;_[n].jsFileList=t,r&&r(null,t)}catch(i){F.error("projectManager.js findAllJSFiles "+i.toString()),r&&r(error,[])}}function o(e,t){var n=e.project,i=n.hash;r(n);var o=decodeURIComponent(e.fileName),a=_[i].cache;if(a[o])return void process.nextTick(function(){t(a[o].error,a[o].data)});var c=n.es6,s=e.needRequire,l=d.join(n.projectpath,o);j.readFile(l,"utf8",function(e,r){if(e)return void t({e:e,type:E.PAGEJS_FILE_ERROR,file:o});if(c){var n=d.basename(o);try{var i=S.transform(r,{presets:["es2015"],sourceMaps:"inline",sourceFileName:n,babelrc:!1});r=i.code.replace("sourceMappingURL=data:application/json;","sourceMappingURL=data:application/json;charset=utf-8;")}catch(e){return void t({e:e,sourceFileName:n},r)}}r='define("'+o+'", function(require, module, exports, '+x+"){ "+r+"\n});",s&&(r+='require("'+o+'")'),a[o]={error:null,data:r},t(null,r)})}function a(e,t,n){r(e);var i=e.hash,o=_[i].cache;if(o[t])return void process.nextTick(function(){n(o[t].error,o[t].data)});var a=d.join(e.projectpath,t);j.readFile(a,function(e,r){e||(o[t]={error:e,data:r}),n(e,r)})}function c(e,t){r(e);var i=e.hash,o=_[i].wxmlFileList;o.length?process.nextTick(function(){t(null,o)}):n(e,t)}function s(e,t){r(e);var n=e.hash,o=_[n].jsFileList;o.length?process.nextTick(function(){t(null,o)}):i(e,t)}function l(e,t){r(e);var n=e.hash,i=g.parse(t),o=i.pathname.replace(/^\//,""),a=d.extname(o),c=a?o.replace(a,".json"):o+".json",s=_[n].cache;if(s[c])return s[c];var l=e.projectpath,u=p(e),h=d.join(l,c),f=j.existsSync(h),v={};if(f){var m=j.readFileSync(h,"utf8");try{v=JSON.parse(m)}catch(w){throw{e:w,data:m,type:E.JSON_PARSE_ERROR,file:c}}}return s[c]=Object.assign({},u.window,v),s[c]}function p(e){r(e);var t=e.hash,n="app.json",i=_[t].cache,o=i[n];if(o)return o;var a=e.projectpath,c=d.join(a,"app.json"),s=void 0;try{s=j.readFileSync(c,"utf8")}catch(l){throw{e:l,type:E.JSON_FILE_ERROR,file:"app.json"}}try{o=JSON.parse(s)}catch(l){throw{e:l,type:E.JSON_PARSE_ERROR,file:"app.json",data:s}}var p=o.pages;if(!p||0===p.length)throw{type:E.JSON_ENTRANCE_ERROR,file:"app.json",data:s};return o.window||(o.window={}),i[n]=o,o}function u(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=R.getBaseURL(e);if(r.justHost)return t;var n=p(e)||{},i=n.pages||[];return g.resolve(t,i[0]+".html")}var h,f,j=require("fs"),d=require("path"),g=require("url"),v=require("events").EventEmitter,m=require("glob"),w=require("chokidar"),S=require("babel-core"),F=require("../../common/log/log.js"),R=require("./tools.js"),y=require("../../stores/projectStores.js"),E=require("../../config/config.js"),x=R.noBrowser.join(","),L=1,_={},O=!1;y.on("PROJECT_STORES_CONFIG_CHANGE",function(e){var r=e.hash;F.info("projectManager.js project config change"),_[r]&&(_[r]={cache:{},wxmlFileList:{},jsFileList:{}})});var N=Object.assign({},v.prototype,{fileChange:function(e,r,t,n){this.emit("FILE_CHANGE",e,r,t,n)},stopWatch:function(){e()},restartWatch:function(){r(this.project)}});_exports={manager:N,getFile:a,getAllWXMLFileList:c,getAllJSFileList:s,getScripts:o,getAppJSONSync:p,getAppEntranceSync:u,getPageJSONSync:l}}var _exports;init(),module.exports=_exports;