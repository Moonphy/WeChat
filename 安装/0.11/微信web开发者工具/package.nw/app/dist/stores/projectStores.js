"use strict";function init(){function t(t){var e=0,r=void 0,o=void 0,i=void 0;if(0===t.length)return e;for(r=0,i=t.length;r<i;r++)o=t.charCodeAt(r),e=(e<<5)-e+o,e|=0;return e>0?e:0-e}function e(){var t=JSON.stringify(E);localStorage.setItem("projectLists",t),n.writeFile(C,t)}function r(t,e){if(e){var r=t.projectpath,o=i.join(__dirname,"../weapp/newquick/");try{var u=c.sync("./**/**",{cwd:o});u.forEach(function(t){var e=i.join(o,t),s=i.join(r,t),c=n.lstatSync(e);if(c.isDirectory())a.sync(s);else{var u=n.readFileSync(e);n.writeFileSync(s,u)}})}catch(f){s.error("projectStores.js initProject error "+f.toString())}}}function o(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},r=require("../actions/windowActions.js"),o="alert";r.showConfirm({content:t,type:o,callback:e})}var i=require("path"),n=require("fs"),s=require("../common/log/log.js"),c=require("glob"),a=require("mkdir-p"),u=require("../common/request/request.js"),f=require("../config/urlConfig.js"),p=require("../config/errcodeConfig.js"),j=(require("../weapp/commit/unpack.js"),require("../config/dirConfig.js")),h=require("events").EventEmitter,d="last-select-project",g=require("../config/config.js"),l=g.SELECT_URL_TYPE,S=g.SELECT_UNKNOW_TYPE,v=j.WeappProjectInfo;if(!v){var P=i.join(nw.App.getDataPath(),"..");v=i.join(P,"WeappProject")}var C=i.join(v,"projectinfo.json"),E=JSON.parse(localStorage.getItem("projectLists"))||[];n.writeFile(C,localStorage.getItem("projectLists")||"[]");var m={},_=null,O=!1,y=parseInt(localStorage.getItem(d))||S,w={Network:{RequestDomain:[],WsRequestDomain:[],UploadDomain:[],DownloadDomain:[]},Setting:{MaxLocalstorageSize:10,MaxCodeSize:5,MaxWebviewDepth:5,MaxBackgroundLifespan:300,MaxRequestConcurrent:5,MaxUploadConcurrent:1,MaxDownloadConcurrent:5,MaxFileStorageSize:100}};E.forEach(function(e){e.hash=t(e.projectid),void 0===e.es6&&(e.es6=!0),void 0===e.watcher&&(e.watcher=!0),void 0===e.editWebview&&(e.editWebview=!0),void 0===e.postcss&&(e.postcss=!0),void 0===e.urlCheck&&(e.urlCheck=!0)});var N=function(t,e){if(!O){O=!0;var r=f.getWeappAttrURL,i=r+"?appid="+t.appid+"&_r="+Math.random();s.info("projectStores.js begin get projectAttr "+i),u({url:i,body:JSON.stringify({appid_list:[t.appid]}),method:"post",needToken:1},function(t,r,i){if(O=!1,t)return s.error("projectStores.js end requestProjectAttr network error: "+JSON.stringify(t)),void e(t);s.info("projectStores.js end requestProjectAttr "+i);var n=void 0;try{n=JSON.parse(i)}catch(c){return s.error("projectStores.js end requestProjectAttr parse body error: "+i+" "+JSON.stringify(t)),void e("系统错误 "+i)}var a=n.baseresponse,u=a?parseInt(a.errcode):0;if(0===u){var f=n.attr_list[0];e(null,f)}else u===p.DEV_App_Not_Band&&(o("当前开发者未绑定此 appid ，请到 mp 后台操作后重试",function(){nw.Shell.openExternal("https://mp.weixin.qq.com/")}),s.error("projectStores.js setProjectConfig error "+u)),e("系统错误 "+i)})}},T=Object.assign({},h.prototype,{getLastSelect:function(){if(y===l||y===S)return parseInt(y);var t=this.getProjectByHash(y);if(t){var e="projectattr"+t.hash,r=JSON.parse(localStorage.getItem(e)),o=t.isTourist;if(r||o)return T.setProjectConfig(t,function(){}),t}return S},setProjectType:function(t){y=t,localStorage.setItem(d,t)},getCurrentProject:function(){return _},getCurrentProjectConfig:function(){return this.getProjectConfig(_)},setProjectPostCss:function(t,r){var o=this.getProjectByHash(t);o.postcss=r,e()},setProjectEs6:function(t,r){var o=this.getProjectByHash(t);o.es6=r,e(),this.emit("PROJECT_STORES_CONFIG_CHANGE",o)},setProjectUrlCheck:function(t,r){var o=this.getProjectByHash(t);o.urlCheck=r,e(),this.emit("PROJECT_STORES_CONFIG_CHANGE",o)},setProjectMinified:function(t,r){var o=this.getProjectByHash(t);o.minified=r,e()},setProjectEditWebview:function(t,r){var o=this.getProjectByHash(t);o.editWebview=r,e(),this.emit("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",o,r)},setProjectWatcher:function(t,r){var o=this.getProjectByHash(t);o.watcher=r,e()},getProjectByHash:function(t){return t=parseInt(t),E.find(function(e){return e.hash===t})},getProjectByID:function(t){return E.find(function(e){return e.projectid===t})},getProjectList:function(){return E},addVerifyProject:function(t,e){},add:function(o,i){o.hash=t(o.projectid),o.es6=!0,o.watcher=!0,o.editWebview=!0,E.unshift(o),r(o,i),e(),s.info("projectStores.js add "+JSON.stringify(o)),this.emit("ADD_PROJECT",E)},del:function(t){var r=E.findIndex(function(e){return e.projectid===t});if(r>-1){var o=E[r];delete localStorage["projectattr"+o.hash],E.splice(r,1),e(),s.info("projectStores.js del "+t),this.emit("DEL_PROJECT",E)}},close:function(){this.emit("CLOSE_PROJECT")},restart:function(t){this.emit("RESTART_PROJECT",t)},getProjectConfig:function(t){return m[t.hash]},setProjectConfig:function(t,e){var r=this;_=t;var i="projectattr"+t.hash,n=JSON.parse(localStorage.getItem(i));if(t.isTourist){var s=Object.assign({},w);return s.appid=t.appid,m[t.hash]=s,void e()}n&&(m[t.hash]=n,e()),N(t,function(s,c){s?"NOT_LOGIN"===s.type?o("登录态失效，请重新登录"):!n&&o(s):(m[t.hash]=c,localStorage.getItem(i)!=JSON.stringify(c)&&(localStorage.setItem(i,JSON.stringify(c)),r.emit("PROJECT_STORES_CONFIG_CHANGE",t)),n||e()),r.emit("PROJECT_CONFIG_REFRESHED")})}});_exports=T}var _exports;init(),module.exports=_exports;