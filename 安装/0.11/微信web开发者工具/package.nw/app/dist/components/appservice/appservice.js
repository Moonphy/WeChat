"use strict";function init(){var e,t=require("../../lib/react.js"),s=(require("../../lib/react-dom.js"),require("../../cssStr/cssStr.js")),o=require("../../stores/webviewStores.js"),i=require("../../stores/windowStores.js"),r=require("../../actions/webviewActions.js"),n=require("../../stores/projectStores.js"),a=require("../../actions/projectActions.js"),p=require("../../weapp/utils/tools.js"),c=require("./../../common/log/log.js"),d=require("../../common/assdk/asSdk.js"),h=require("../../debugger/debugger.js"),v=require("../../config/dirConfig.js"),u=require("../../actions/windowActions.js"),_=require("./console/showconsole.js"),g=require("../../config/config.js"),m=require("./port/port.js"),l=1e5,E=1e6,f="about:blank",w={},S=function(e,t){u.showConfirm({content:e,callback:t})},A=t.createClass({displayName:"DevTools",getInitialState:function(){return{isWxml:!1}},addContentScripts:function(e){e.addContentScripts([{name:"contentScripts",matches:["<all_urls>"],js:{files:["app/dist/contentscript/contentScript.js"]},run_at:"document_start"}])},_initport:function(e){var t=e.name;if(t==="webview"+l)this.port.init(e),this.port.postMessage("contentscript",{},"SHAKE_HANDS");else if(t==="webview"+E){if(this.devtoolsview.src===f)return;this.devtoolsPort.init(e),this.devtoolsPort=e,this.devtoolsPort.postMessage("contentscript",{},"SHAKE_HANDS")}},_externalPort:function(e){var t=e.name;"storage"===t?(this.storagePort.init(e),this.storagePort.postMessage("",{},"SHAKE_HANDS")):"appdata"===t?(this.appdataPort.init(e),this.appdataPort.postMessage("",{},"SHAKE_HANDS")):"wxml"===t&&(this.wxmlPort.init(e),this.wxmlPort.postMessage("",{},"SHAKE_HANDS"))},initRuntime:function(){chrome.runtime.onConnect.addListener(this._initport)},storageMessage:function(e){if("GET_APP_DATA"===e.command){var t={storage:p.getProjectStorage(this.props.project)};this.storagePort.postMessage("",t,"tabui-setAsData")}},wxmlMessage:function(e){var t=this,s=e.command,i=e.ext,r=e.data;if("GET_CURRENT_DEBUGGEE"===s){var n=o.getCurrentWebviewID(),a=this.debuggeeMap[n];if(!a)return void c.error("appservice.js error do not find "+n+" debuggee");this.wxmlPort.postMessage("",{res:{debuggee:a},ext:i,args:r},"GET_CURRENT_DEBUGGEE")}else"SEND_COMMAND"===s?("DOM.setInspectMode"===r.method&&"none"===r.commandParams.mode&&this.setState({isWxml:!1}),h.sendCommand(r.debuggee,r.method,r.commandParams,function(e){t.wxmlPort.postMessage("",{res:e,ext:i,args:r},"GET_DEVTOOLS_RES")})):"OPEN_FILE"===s&&u.openProjectFile(r)},appdataMessage:function(e){var t=e.command;"GET_APP_DATA"===t?this.port.postMessage("appservice",{},"GET_APP_DATA"):"WRITE_APP_DATA"===t&&this.port.postMessage("appservice",e.data,"WRITE_APP_DATA")},onMessage:function(e){var t=this;if("COMMAND_FROM_ASJS"===e.command){var s=e.sdkName;return"__open-tools-log"===s?void nw.Shell.openItem(v.WeappLog):"__open-tools-vendor"===s?void nw.Shell.openItem(v.WeappVendor):"APP_SERVICE_COMPLETE"===s?void o.emit("APPSERVICE_INIT"):"send_app_data"===s?void this.appdataPort.postMessage("",e,"SEND_APP_DATA"):"publish"===s?void r.asPublish(e):void d.exec(e,function(s,o){setTimeout(function(){t.port.postMessage("appservice",s,"GET_ASSDK_RES",e)},0)})}},initExternal:function(){chrome.runtime.onConnectExternal.addListener(this._externalPort)},_initAppservice:function(){function e(){function t(){s.removeEventListener("loadcommit",t),s.showDevTools(!0,i)}i.removeEventListener("loadcommit",e),s.addEventListener("loadcommit",t),s.src="http://"+n.hash+".appservice.open.weixin.qq.com/appservice"}var t=this.refs.container,s=this.appserviceWebview=document.createElement("webview");s.style.cssText="height:0.01px;width:0.01px";var o=s.getUserAgent();s.setUserAgentOverride(o+" appservice webview/"+l),t.appendChild(s),this.addContentScripts(s);var i=this.devtoolsview=document.createElement("webview");i.className="devtools-content";var r=i.getUserAgent()+" asviewdevtools webview/"+E+" chromeRuntimeID/"+chrome.runtime.id;i.setUserAgentOverride(r),i.setAttribute("partition","persist:devtools"),t.appendChild(i),this.addContentScripts(i);var n=this.props.project;i.addEventListener("loadcommit",e),i.src=f,this.initRuntime(),this.initExternal(),this.onHeadersReceived(),this.onBeforeSendHeaders(),this.onSyncMessage()},_postMsgToAS:function(e){this.port.postMessage("appservice",e,"MSG_FROM_WEBVIEW")},_upASData:function(e,t){var s={storage:t};this.storagePort.postMessage("",s,"tabui-setAsData")},_restart:function(){var e=this.props.project;this.appserviceWebview.src="http://"+e.hash+".appservice.open.weixin.qq.com/appservice"},_startDebuggee:function(e,t){var s=this,i=t.webview,n=t.webviewOffset;new Date;h.start(i,{webviewOffset:n},function(t){s.debuggeeMap[e]=t,s.wxmlPort.postMessage("",{debuggee:t},"CHANGE_DEBUGGEE"),r.touchSetSuc(e)},function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("DOM.inspectNodeRequested"===t&&s.setState({isWxml:!1}),"DOM.inlineStyleInvalidated"!==t&&"DOM.characterDataModified"!==t&&("DOM.nodeHighlightRequested"!==t||"DOM.nodeHighlightRequested"!==w.method||i.nodeId!==w.nodeId)){w="DOM.nodeHighlightRequested"===t?{method:t,nodeId:i.nodeId}:{};var r=o.getOffset();s.wxmlPort.postMessage("",{debuggee:e,method:t,params:i,offset:r},"ON_EVENT")}},function(e,t){s.wxmlPort.postMessage("",{debuggee:e},"ON_DETACH");for(var o in s.debuggeeMap)if(s.debuggeeMap[o].targetId===e.targetId)return void delete s.debuggeeMap[o]})},_changeWebview:function(e){var t=this.debuggeeMap[e];t&&this.wxmlPort.postMessage("",{debuggee:t},"CHANGE_DEBUGGEE")},_setWebviewInfo:function(e){for(var t in this.debuggeeMap)h.sendCommand(this.debuggeeMap[t],"Emulation.setDeviceMetricsOverride",{width:parseInt(e.width),height:parseInt(e.height),deviceScaleFactor:e.dpr,mobile:!0,fitWindow:!1})},_getWeappError:function(e,t,s){this.port.postMessage("appservice",{fileName:p.getFileNameFromUrl(t),errStr:s},"WINDOW_GET_WEBAPP_ERROR")},inspector:function(){return this.wxmlPort.hasInit?(this.setState({isWxml:!0}),void this.wxmlPort.postMessage("",{},"SET_INSPECT_MODE")):void u.showTipsMsg({msg:"请先切换至 Wxml Pannel",type:"error"})},onSyncMessage:function(){var e=this.appserviceWebview;e.addEventListener("dialog",function(e){var t=e.messageType||"",s=e.messageText;if("prompt"===t){var o=/^____sdk____/.test(s);o&&!function(){var t=JSON.parse(s.replace(/^____sdk____/,""));"COMMAND_FROM_ASJS"===t.command&&!function(){var s=t.sdkName;d.exec(t,function(o,i){var n={to:"appservice",msg:o,command:"GET_ASSDK_RES",ext:t};e.dialog.ok(JSON.stringify(n)),"setStorageSync"!==s&&"clearStorageSync"!==s||r.upASData(i.appid,i.storage)})}()}()}else"confirm"===t&&!function(){e.preventDefault();var t=e.dialog;S(s,function(e){e?t.ok():t.cancel()})}()})},onBeforeSendHeaders:function(){var t=this,s=this.appserviceWebview,o=s.request,i=this.props.project;o.onBeforeSendHeaders.addListener(function(s){var o=s.url;if("main_frame"===s.type&&o.match(/\?load$/))return clearTimeout(e),e=setTimeout(function(){a.restart(t.props.project)},500),{cancel:!0};var r=s.requestHeaders||[],n=r.findIndex(function(e){return"cookie"===e.name.toLowerCase()});r.splice(n,1);for(var p=0;p<r.length;++p)"_Cookie"===r[p].name&&(r[p].name="Cookie"),"Referer"===r[p].name&&(r[p].value="https://servicewechat.com/"+i.appid+"/devtools/page-frame.html");return{requestHeaders:s.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"])},onHeadersReceived:function(){var e=this,t=this.appserviceWebview,s=t.request;s.onHeadersReceived.addListener(function(t){var s=t.type;if("script"===s){var o=t.responseHeaders||[],i=o.find(function(e){return e.name===g.ES6_ERROR});i&&e._showWeappError(g.ES6_ERROR,i.value)}},{urls:["<all_urls>"]},["blocking","responseHeaders"])},_showWeappError:function(e,t){"edit"===this.props.propshow&&/ERROR$/.test(e)&&e!==g.WEBVIEW_ERROR&&setTimeout(function(){u.showTipsMsg({msg:"编译出现错误，请去控制台查看详细信息",type:"error"})}),_(this.appserviceWebview,e,t)},componentDidMount:function(){this.port=new m({onMessage:this.onMessage}),this.devtoolsPort=new m,this.storagePort=new m({onMessage:this.storageMessage}),this.wxmlPort=new m({onMessage:this.wxmlMessage}),this.appdataPort=new m({onMessage:this.appdataMessage}),this.debuggeeMap={},this._initAppservice(),o.on("POST_MSG_TOAS",this._postMsgToAS),o.on("UP_AS_DATA",this._upASData),n.on("RESTART_PROJECT",this._restart),i.on("START_WEBVIEW_DEBUGGEE",this._startDebuggee),i.on("WINDOW_CHANGE_WEBVIEW_ID",this._changeWebview),i.on("SET_WEBVIEW_INFO",this._setWebviewInfo),i.on("WINDOW_GET_WEBAPP_ERROR",this._getWeappError),i.on("WINDOW_SHOW_WEBAPP_ERROR",this._showWeappError)},componentWillUnmount:function(){this.devtoolsview.remove(),this.appserviceWebview.remove(),o.removeListener("POST_MSG_TOAS",this._postMsgToAS),o.removeListener("UP_AS_DATA",this._upASData),n.removeListener("RESTART_PROJECT",this._restart),i.removeListener("START_WEBVIEW_DEBUGGEE",this._startDebuggee),i.removeListener("WINDOW_CHANGE_WEBVIEW_ID",this._changeWebview),i.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),i.removeListener("WINDOW_GET_WEBAPP_ERROR",this._getWeappError),i.removeListener("WINDOW_SHOW_WEBAPP_ERROR",this._showWeappError),chrome.runtime.onConnectExternal.removeListener(this._externalPort),chrome.runtime.onConnect.removeListener(this._initport)},render:function(){var e="appservice"===this.props.show?{height:"100%"}:s.webviewDisplayNone;"edit"===this.props.propshow&&(e=s.webviewDisplayNone);var o="debug"===this.props.propshow?{}:s.displayNone,i=this.state.isWxml?"devtools-inspector devtools-inspector-active":"devtools-inspector";return t.createElement("div",{style:e,ref:"container",className:"devtools"},t.createElement("div",{className:"devtools-inspector-bg",style:o}),t.createElement("div",{style:o,onClick:this.inspector,className:i}))}});_exports=A}var _exports;init(),module.exports=_exports;