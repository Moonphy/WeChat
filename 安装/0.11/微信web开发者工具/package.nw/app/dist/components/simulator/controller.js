"use strict";function init(){var e=require("../../lib/react.js"),t=require("../../lib/react-dom.js"),r=require("./toolbar/toolbar.js"),i=require("./toolbar/scanDialog.js"),s=require("./webviewtab.js"),o=require("./webviewWeappShare.js"),a=require("./webview.js"),n=require("../../weapp/utils/tools.js"),c=require("../../stores/webviewStores.js"),p=(require("../../stores/windowStores.js"),require("../../actions/windowActions.js")),l=require("../../actions/webviewActions.js"),u=(require("../../stores/projectStores.js"),require("../../cssStr/cssStr.js")),h=(require("../../common/log/log.js"),require("../../common/request/request.js")),v=require("./actions/simulatorActions.js"),f=require("./webviewBackwardMask.js"),d=(require("../../utils/tools.js"),require("url")),g=require("../../config/urlConfig.js"),w=require("../../weapp/utils/projectManager.js"),b=require("./webview/modal.js"),S=require("./webview/toast.js"),m=require("./webview/Picker"),_=require("./webview/ActionSheet.js"),W=require("./webview/previewImage.js"),I=require("../../config/weappConfig.js"),E=I.default_tabheight,y=I.default_backgroundColor,D=0,N=0,T=e.createClass({displayName:"Controller",getInitialState:function(){var e="app/html/about.html",t=0,r=0,i={},s={window:{}},o={},a={},n=c.getOffset(),p=!1,l=!1,u="",h=this.props.project;if(h){try{e=w.getAppEntranceSync(h),s=w.getAppJSONSync(h),i=s.tabBar||{};var v=s.pages||[];a=w.getPageJSONSync(h,v[0])}catch(f){e=""}var d=this.getTabPageIndex(e,i);p=d>-1&&i.list[d].pagePath}return{currentWebviewID:t,showCard:l,tabBar:i,appJSON:s,offset:n,cardInfo:o,list:{0:{href:e,dataURI:u,preWebviewID:r,pageJSON:a,isTabbar:p}},share:{show:!1,imgUrl:"",title:"",desc:""}}},setAnimateImg:function(e,r){var i=document.createElement("div");if(r.dataURI){var s=document.createElement("img");i.appendChild(s),s.src=r.dataURI}i.className="simulator-animate-png";var o=t.findDOMNode(this.refs["webview"+this.state.currentWebviewID]),a=o.getBoundingClientRect(),n=a.top,c=a.left,p=a.height,l=a.width;e?i.style.cssText="background-color:"+r.color+";width:"+l+"px;height:"+p+"px;top:"+n+"px;left:"+c+"px;transform:translate3d("+l+"px,0,0)":i.style.cssText="margin-top:42px;width:"+l+"px;height:"+(p-42)+"px;top:"+n+"px;left:"+c+"px;transform:translate3d(0,0,0)",global.contentDocumentBody.appendChild(i);i.offsetTop;return i},postAppRoute:function(e,t,r){if(this.props.project){e=e.replace(/http\:\/\/.*?\//,"");var i=e.match(/(([^\?]*)(\?([^\/]*))?)$/),s="",o={};if(i){s=i[2]||"index.wxml";for(var a=(i[4]||"").split("&"),n=0;n<a.length;++n){var c=a[n].split("=");2==c.length&&(o[c[0]]=c[1])}}this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:"onAppRoute",type:"ON_APPLIFECYCLE_EVENT",data:{path:s,query:o,openType:r},webviewID:t})}},goBack:function(e,r,i,s){var o=this;if(s=s||1,this.props.project||!r.canGoBack()||i){var a,c,p,l=function(){if(0===e)return{v:void 0};for(c=e,p=[];s--&&o.state.list[c]&&0!=c;)p.push(c),a=o.state.list[c],c=a.prevWebviewID;o.state.list[c]||(c=0);var i=t.findDOMNode(o.refs["webview"+e]),l=i.querySelector(".webviewbody"+e);l.captureVisibleRegion(function(e){var i=o.setAnimateImg(!1,{dataURI:e}),s=l.offsetWidth,a=Object.assign({},o.state.list);for(var u in p)delete a[p[u]];o.setState({list:a,currentWebviewID:c},function(){i.addEventListener("transitionend",function(){global.contentDocumentBody.removeChild(i);var e=t.findDOMNode(o.refs["webview"+c]),s=e.querySelector(".webviewbody"+c);if(o.props.project){var a=r.src,l=n.getBaseURL(o.props.project);0===a.indexOf(l)&&o.postAppRoute(s.src,o.state.currentWebviewID,"navigateBack")}for(var u in p)o.getSimulatorActions("S_DELETE_WEBVIEW",null,{webviewID:p[u]});o.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:c})}),i.style.transform="translate3d("+s+"px,0,0)"})})}();if("object"===("undefined"==typeof l?"undefined":_typeof(l)))return l.v}else r.back()},_getOpenWebviewNum:function(){var e=this.state.list,t=1;for(var r in e)e.hasOwnProperty(r)&&e[r]&&!e[r].isTabbar&&t++;return t},_openNewWebview:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},i=e.webviewID,s=e.url,o=e.isMap;if(!e.isMap&&this._getOpenWebviewNum()>5)return void r(-1);var a=this.state.appJSON,n={},c=y;if(!o){try{n=w.getPageJSONSync(this.props.project,s)}catch(p){}c=n.backgroundColor||a.window.backgroundColor||y}var l=this.setAnimateImg(!0,{color:c});l.style.transform="translate3d(0,0,0)",r(null),l.addEventListener("transitionend",function(){l.parentNode.removeChild(l),D++;var e=Object.assign({},t.state.list);e[D]={prevWebviewID:i,href:s,pageJSON:n,isMap:o},t.setState({currentWebviewID:D,list:e}),t.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:D})})},_openNewWindowWebview:function(e){var t=this,r=e.url,i={},s=this.props.project;try{i=w.getPageJSONSync(s,r)}catch(o){}var a=(i.backgroundColor||"#ffffff",n.getBaseURL(s));r=d.resolve(a,r+".html");var c=this.state.list,p={};for(var l in c)if(c[l].isTabbar===e.url){p.currentWebviewID=l;break}if(void 0===p.currentWebviewID){p.currentWebviewID=++D;var u=Object.assign({},this.state.list);u[D]={showUrl:!1,hideBack:!0,isTabbar:e.url,href:r,pageJSON:i},p.list=u}var h=p.currentWebviewID;return this.setState(p,function(){t.postAppRoute(r,h,"switchTab"),t.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:h})}),h},_changeWebviewID:function(e){this.setState({currentWebviewID:e})},_setWebviewInfo:function(e){var t=this.state.tabBar;t.list||[];e.height&&this.setState({offset:{height:e.height,width:e.width,dpr:e.dpr}})},_setWebviewSnapshot:function(e,t){var r=Object.assign({},this.state.list);r[e].dataURI=t,this.setState({list:r})},_postMessageToAllWebview:function(e){var t=this,r=e.webviewIds||[],i=0===r.length;setTimeout(function(){e.act="sendMsgFromAppService";var s=void 0;s=i?Object.keys(t.state.list):r,s.forEach(function(r){t.getSimulatorActions("S_SET_ACTION",r,e)})},17)},_getShortUrl:function(e){var t="";if(this.props.project){var r=this.props.project;t=n.getBaseURL(r)}return e.replace(t,"")},_asSdk:function(e,r,i){var s=this;if("redirectTo"===e){var o=this.state.currentWebviewID,a=t.findDOMNode(this.refs["webview"+o]),n=a.querySelector(".webviewbody"+o);n.src=r.args.url;var p={};try{p=w.getPageJSONSync(this.props.project,r.args.url)}catch(u){}var v=Object.assign({},this.state.list);v[o].pageJSON=p,this.setState({list:v}),i({errMsg:"redirectTo:ok",url:this._getShortUrl(r.args.url),webviewId:o})}else if("navigateTo"===e){var f=this.state.currentWebviewID;this._openNewWebview({webviewID:f,url:r.args.url},function(e){i(null!==e?{errMsg:"navigateTo:fail webview count limit exceed."}:{errMsg:"navigateTo:ok",url:s._getShortUrl(r.args.url),webviewId:D+1})})}else if("navigateBack"===e)!function(){var e=s.state.currentWebviewID,o=t.findDOMNode(s.refs["webview"+e]),a=o.querySelector(".webviewbody"+e);s.goBack(s.state.currentWebviewID,a,!1,r.args.delta||1),setTimeout(function(){i({errMsg:"navigateBack:ok",url:s._getShortUrl(a.src)})},200)}();else if("setNavigationBarTitle"===e)setTimeout(function(){var t=s.state.currentWebviewID,o=r.args;s.getSimulatorActions("S_SET_WEBVIEW_MARGIN",t,{name:e,value:o.title||""}),i({errMsg:"setNavigationBarTitle:ok"})},400);else if("showNavigationBarLoading"===e)!function(){var t=s.state.currentWebviewID;r.args;setTimeout(function(){s.getSimulatorActions("S_SET_WEBVIEW_MARGIN",t,{name:e}),i({errMsg:e+":ok"})},0)}();else if("hideNavigationBarLoading"===e)!function(){var t=s.state.currentWebviewID;r.args;setTimeout(function(){s.getSimulatorActions("S_SET_WEBVIEW_MARGIN",t,{name:e}),i({errMsg:e+":ok"})},0)}();else if("chooseLocation"===e)!function(){var e=s.state.currentWebviewID,t=r.url;s._openNewWebview({isMap:!0,webviewID:e,url:t});var o={};s.chooseLocation=function(e){return e?void(o=e):void i(0===Object.keys(o).length?{errMsg:"chooseLocation:fail"}:{name:o.poiname,address:o.poiaddress,latitude:o.latlng.lat,longitude:o.latlng.lng,errMsg:"chooseLocation:ok"})},s.closeLocation=function(){i({errMsg:"chooseLocation:cancel"})}}();else if("openLocation"===e){var d=this.state.currentWebviewID;this._openNewWebview({isMap:!0,webviewID:d,url:r.url}),i({errMsg:"openLocation:ok"})}else if("scanCode"===e)!function(){var e=function s(e){i("ok"==e.msg?{errMsg:"scanCode:ok",result:e.result,scanType:e.scanType}:"cancel"==e.msg?{errMsg:"scanCode:cancel"}:{errMsg:"scanCode:"+e.msg}),c.removeListener("SCAN_CODE_RETURN",s)},t=r.args;setTimeout(function(){l.showScanCodeDialog(t),c.on("SCAN_CODE_RETURN",e)},0)}();else if("operateWXData"===e)!function(){var e="",t=r.args;if(s.props.project){var o=s.props.project;e=o.appid}h({url:g.jsOperateWXDATAURL+"?appid="+e,method:"post",body:JSON.stringify({data:JSON.stringify(t.data||{})}),needToken:1},function(r,o,a){var n={},p="";if(!r&&200===o.statusCode&&(a=JSON.parse(a),a.baseresponse))if(0==a.baseresponse.errcode)try{n.data=JSON.parse(a.data),n.errMsg="operateWXData:ok"}catch(l){n.errMsg="operateWXData:fail"}else if(a.baseresponse.errcode==-12e3){var u,v=function(){u=N++;var r=function o(r,s,a){n.errMsg=a?"operateWXData:ok":"operateWXData:cancel";var p=s[0];if(a&&p.checked){var l={data:JSON.stringify(t.data||{}),grant_scope:p.scope};h({url:g.jsOperateWXDATAURL+"?appid="+e,method:"post",body:JSON.stringify(l),needToken:1},function(e,t,r){var s={};if(!e&&200===t.statusCode&&(r=JSON.parse(r),r.baseresponse&&0===r.baseresponse.errcode))try{s.data=JSON.parse(r.data),s.errMsg="operateWXData:ok"}catch(o){s.errMsg="operateWXData:fail"}s.errMsg||(s.errMsg="operateWXData:fail; "),i(s)})}else i(n);c.removeListener("AUTHORIZE_SDK_RETURN_"+r,o)};return c.on("AUTHORIZE_SDK_RETURN_"+u,r),s.getSimulatorActions("S_AUTHORIZE_SDK",s.state.currentWebviewID,{authorizeSdkId:u,url:a.appicon_url+"/0",appname:a.appname,scope_list:[a.scope]}),{v:void 0}}();if("object"===("undefined"==typeof v?"undefined":_typeof(v)))return v.v}else p=a.baseresponse.errmsg;n.errMsg||(n.errMsg="operateWXData:fail "+p),i(n)})}();else if("authorize"===e)!function(){var e="";if(s.props.project){var t=s.props.project;e=t.appid}var o=r.args,a={scope:o.scope||[]};h({url:g.jsAuthorizeURL+"?appid="+e,method:"post",body:JSON.stringify(a),needToken:1},function(t,r,o){var a={},n="";if(!t&&200===r.statusCode&&(o=JSON.parse(o),o.baseresponse))if(a.body=o,0==o.baseresponse.errcode)a.errMsg="authorize:ok";else if(o.baseresponse.errcode==-12e3){var p,l=function(){p=N++;var t=function r(t,s,o){if(a.errMsg=o?"authorize:ok":"authorize:cancel",o){for(var n=[],p=0;p<s.length;++p){var l=s[p];l.checked&&n.push(l.scope)}console.log(s);var u={scope:n};h({url:g.jsAuthorizeConfirmURL+"?appid="+e,method:"post",body:JSON.stringify(u),needToken:1},function(e,t,r){var s={};e||200!==t.statusCode||(r=JSON.parse(r),r.baseresponse&&0===r.baseresponse.errcode&&(s.errMsg="authorize:ok")),s.errMsg||(s.errMsg="authorize:fail"),i(s)})}else i(a);c.removeListener("AUTHORIZE_SDK_RETURN_"+t,r)};return c.on("AUTHORIZE_SDK_RETURN_"+p,t),s.getSimulatorActions("S_AUTHORIZE_SDK",s.state.currentWebviewID,{authorizeSdkId:p,url:o.appicon_url+"/0",appname:o.appname,scope_list:o.scope_list}),{v:void 0}}();if("object"===("undefined"==typeof l?"undefined":_typeof(l)))return l.v}else n=o.baseresponse.errmsg;a.errMsg||(a.errMsg="authorize:fail "+n),i(a)})}();else if("getSystemInfo"===e||"getSystemInfoSync"===e){var b=this.state.currentWebviewID,S=c.getInfo(),m=this.state.list[b];i({errMsg:e+":ok",model:S.model,pixelRatio:S.dpr,windowWidth:S.width,windowHeight:this.getTabPageIndex(m.href)>-1?S.height-E:S.height,language:"zh_CN",version:"6.3.9"})}else if("shareAppMessage"===e){var _=r.args,W={show:!0,title:_.title,dest:_.desc,imgUrl:_.imgUrl,callback:i};this.setState({share:W})}},_upWebviewStatus:function(e,t){this.upCurrentWebviewURL(t.url)},getTabPageIndex:function(e,t){var r=n.getFileNameFromUrl(e,this.props.project).replace(/\.wxml$/,"");t=t||this.state.tabBar;var i=t.list||[],s=i.findIndex(function(e){return e.pagePath===r});return s},upCurrentWebviewURL:function(e){},getSimulatorActions:function(e,r,i){var s={currentWebviewID:this.state.currentWebviewID};if(v(e,r,i,s),"S_CHANGE_CURRENT_WEBVIEW"===e){var o=i.webviewID;if(o===this.state.currentWebviewID){var a=t.findDOMNode(this.refs["webview"+o]),n=a.querySelector("webview"),c=n.src;this.upCurrentWebviewURL(c),p.changeUrl(c,o)}}},projectHasTab:function(){var e=this.state.tabBar.list||[],t=e.length;return t&&e.length<=5&&e.length>=2},componentDidMount:function(){c.on("CHANGE_WEBVIEW_ID",this._changeWebviewID),c.on("SET_WEBVIEW_INFO",this._setWebviewInfo),c.on("AS_PUBLISH",this._postMessageToAllWebview),c.on("SEND_AS_SDK",this._asSdk),c.on("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),c.on("UP_WEBVIEW_STATUS",this._upWebviewStatus);var e=this.props.project?1:12;chrome.fontSettings.setMinimumFontSize({pixelSize:e})},componentWillUnmount:function(){c.removeListener("CHANGE_WEBVIEW_ID",this._changeWebviewID),c.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),c.removeListener("AS_PUBLISH",this._postMessageToAllWebview),c.removeListener("SEND_AS_SDK",this._asSdk),c.removeListener("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),c.removeListener("UP_WEBVIEW_STATUS",this._upWebviewStatus)},chooseLocation:function(){},closeLocation:function(){},hideShare:function(){var e={show:!1};this.setState({share:e})},render:function(){var t=[];for(var n in this.state.list){var c=n==this.state.currentWebviewID?{}:u.webviewDisplayNone,p=this.state.list[n],l=this.getTabPageIndex(p.href),h=null,v=null,d=Object.assign({},this.state.offset);if(this.projectHasTab()&&l>-1){var g=this.state.tabBar.position,w={width:this.state.offset.width,margin:"0 auto"},I=e.createElement("div",{style:w},e.createElement(s,{webviewID:n,tabPageIndex:l,project:this.props.project,_openNewWindowWebview:this._openNewWindowWebview,tabBar:this.state.tabBar}));"top"===g?h=I:v=I,d.height=d.height-E}t.push(e.createElement("div",{key:n,style:c},e.createElement("div",{className:"simulator-shadow",style:{width:d.width}},h,e.createElement(a,{ref:"webview"+n,webviewID:n,project:this.props.project,offset:d,isTabWebview:l>-1,href:p.href,pageJSON:p.pageJSON,appJSON:this.state.appJSON,isMap:p.isMap,chooseLocation:this.chooseLocation,closeLocation:this.closeLocation,hideBack:!!p.hideBack,goBack:this.goBack,getSimulatorActions:this.getSimulatorActions,postAppRoute:this.postAppRoute}),v)))}var y=this.props.project?e.createElement(o,{share:this.state.share,hideShare:this.hideShare}):null;return e.createElement("div",{className:"simulator-wrapper"},e.createElement(r,{getSimulatorActions:this.getSimulatorActions,list:this.state.list,currentWebviewID:this.state.currentWebviewID,project:this.props.project,show:this.props.show}),e.createElement(i,{currentWebviewID:this.state.currentWebviewID}),e.createElement("div",{className:"simulator-list-wrapper",style:{width:this.state.offset.width}},y,t,e.createElement(_,null),e.createElement(S,{project:this.props.project}),e.createElement(b,null),e.createElement(m,{webviewID:this.state.currentWebviewID}),e.createElement(W,{width:this.state.offset.width,project:this.props.project})),e.createElement(f,null))}});_exports=T}var _typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":_typeof2(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":_typeof2(e)},_exports;init(),module.exports=_exports;