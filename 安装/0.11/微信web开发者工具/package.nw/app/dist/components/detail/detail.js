"use strict";function init(){function e(e){var t=e?new Date(e):new Date;return t.toLocaleDateString()+" "+t.toLocaleTimeString()}var t=require("../../lib/react.js"),s=require("../../cssStr/cssStr.js"),a=(require("../../utils/tools.js"),require("../../weapp/commit/upload.js")),r=require("../../actions/projectActions.js"),i=require("../../common/log/log.js"),o=require("../../utils/newReport.js"),l=(require("../../stores/webviewStores.js"),require("../../stores/windowStores.js")),c=require("../../config/errcodeConfig.js"),n=require("../../actions/windowActions.js"),p=require("../../stores/projectStores.js"),d=require("./uploadInfo.js"),m=require("./detailConfig.js"),h=function(e){n.showTipsMsg({msg:e,type:"error"})},u=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};n.showConfirm({content:e,callback:t})},E=t.createClass({displayName:"Detail",getInitialState:function(){var e=this.props.project,t=e.isTourist,s=localStorage["last-up-test-time-"+e.hash],a=localStorage["last-up-load-time-"+e.hash];return{lastUploadTime:t?"项目未关联AppID":a?a:"未上传",lastTestTime:t?"项目未关联AppID":s?s:"未提交",testBtnClass:"detail-meta-upload",testBtnTitle:"预览",tabIndex:0,qrcode_img:"",isTourist:t,es6:e.es6,minified:e.minified,watcher:e.watcher,postcss:e.postcss,urlCheck:e.urlCheck}},closeImg:function(){this.setState({qrcode_img:""})},upload:function(){var e=this.props.project,t=e.isTourist;t||this.refs.uploadWnd.startUpload()},openProject:function(e){nw.Shell.openItem(e)},delProject:function(){var e=this;u("确认删除 "+decodeURIComponent(this.props.project.appname)+" ?",function(t){if(t){var s=e.props.project.appid;r.del(e.props.project.projectid),delete localStorage["last-up-test-time-"+e.props.project.hash],delete localStorage["last-up-load-time-"+e.props.project.hash],o("project_delete",s)}})},uploadForTest:function(e){var t=this,s=this.props.project,r=s.isTourist;r||this.lock||(this.setState({testBtnClass:"detail-upload-dialog-button-primary detail-upload-dialog-button-primary-loading",testBtnTitle:"上传中"}),this.lock=!0,a.uploadForTest(this.props.project,{},function(e,s,a,r){t.getResp({error:e,resp:s,res:a,options:r,type:"test"})}))},getResp:function(t){var s=this;this.lock=!1;var a=t.error,r=(t.resp,t.res),o=t.type,l=t.options,n={testBtnClass:"detail-meta-upload",testBtnTitle:"预览"};if(a){var p="string"==typeof a?a:JSON.stringify(a);u(p||"提交预览出错，请去调试窗口编译代码，查看详细错误信息",function(){s.setState(n)})}else{try{r=JSON.parse(r)}catch(d){return h("系统错误，上传回包："+r),void this.setState(n)}var m=r.baseresponse,E=m?parseInt(m.errcode):0,f=parseInt(r.wxpkg_size/1024);if(E===c.DEV_App_Not_Band)return u("当前开发者未绑定此 appid ，请到 mp 后台操作后重试"),nw.Shell.openExternal("https://mp.weixin.qq.com/"),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_Need_Admin)return u("需要管理员才能进行上传操作，请检查后重试"),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_Need_SCAN_CODE)return u("请重新扫码确认"),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_COMPILE_EMPTY_SOURCE)return u("代码包为空，请检查后重试"),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_COMPILE_WXPKG_MAX_LIMIT)return u("编译包大小为 "+f+" kb，超过限制 "+(f-l.MAX_APP_LENGTH)+" kb，请删除文件后重试"),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_COMPILE_INVALID_WXPKG)return u("代码包错误，错误代码 "+E),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_COMPILE_WXML_FAIL)return u("wxml 编译错误，错误信息："+r.compile_err_msg),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_COMPILE_WXSS_FAIL)return u("wxss 编译错误，错误信息："+r.compile_err_msg),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_COMPILE_INVALID_JSON_FILE)return u("json 编译错误，错误信息："+r.compile_err_msg),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_COMPILE_LACK_OF_FILE)return u("缺少文件，错误信息："+r.compile_err_msg),i.error("details.js uploadForTest error "+E),void this.setState(n);if(E===c.DEV_Need_Update)return u("工具版本过旧，请升级工具后重试"),i.error("details.js uploadForTest error "+E),void this.setState(n);var j=e();if(f&&(j=j+", 编译包大小 "+f+" kb"),0===E){n.qrcode_img=r.qrcode_img;var g=+new Date+15e5,v=new Date(g);n.qrcode_time=v,"test"===o?(n.lastTestTime=j,localStorage.setItem("last-up-test-time-"+this.props.project.hash,j)):(n.lastUploadTime=j,localStorage.setItem("last-up-load-time-"+this.props.project.hash,j)),n.showDailog=!1,this.setState(n)}else u("系统错误，错误代码："+E+",错误信息："+m.errmsg,function(){s.setState(n)})}},onEs6Change:function(){var e=!this.state.es6;p.setProjectEs6(this.props.project.hash,e),this.setState({es6:e})},onPostCss:function(){var e=!this.state.postcss;p.setProjectPostCss(this.props.project.hash,e),this.setState({postcss:e})},onMinified:function(){var e=!this.state.minified;p.setProjectMinified(this.props.project.hash,e),this.setState({minified:e})},onAutoWatcher:function(){var e=!this.state.watcher;p.setProjectWatcher(this.props.project.hash,e),this.setState({watcher:e})},onUrlCheck:function(){var e=!this.state.urlCheck;p.setProjectUrlCheck(this.props.project.hash,e),this.setState({urlCheck:e})},changeTab:function(e){this.setState({tabIndex:e})},render:function(){var e=this,a=this.props,r=a.show,i=a.project,o=this.state.isTourist,c="detail"===r?{}:s.displayNone,n=i.app_head_img||"../images/logo.png",p=i?decodeURIComponent(i.appname):"",h=i?i.appid:"",u=i?i.projectpath:"",E="",f=s.displayNone,j="";if(this.state.qrcode_img){E=t.createElement("img",{src:"data:image/png;base64,"+this.state.qrcode_img,style:{width:"200px",heigth:"200px",marginBottom:"20px"}}),f={};var g=l.getUserInfo();j="请使用 "+g.nickName+" 的微信扫描二维码，预览当前开发版本，二维码将在 "+this.state.qrcode_time.toTimeString().replace(/\s.*/g,"")+" 时失效。"}var v=this.state.tabIndex,_=this.state.es6,N=this.state.minified,S=this.state.watcher,C=this.state.postcss,T=this.state.urlCheck;return t.createElement("div",{className:"detail",style:c},t.createElement("div",{className:"detail-logo-wrapper"},t.createElement("img",{src:n,className:"detail-logo"}),t.createElement("p",{className:"detail-name"},p),t.createElement("p",{className:"detail-appid"},"App ID: ",h)),t.createElement("div",{className:"detail-meta-tab"},t.createElement("div",{className:"detail-meta-tab-hd",style:this.props.project.isTourist?s.displayNone:{}},t.createElement("a",{href:"javascript:;",onClick:function(){e.changeTab(0)},className:0===v?"detail-meta-tab-item-active":""},"基础信息"),t.createElement("a",{href:"javascript:;",onClick:function(){e.changeTab(1)},className:1===v?"detail-meta-tab-item-active":""},"配置信息")),t.createElement("div",{style:0===v?{}:s.displayNone},t.createElement("div",{className:"detail-meta-tab-bd"},t.createElement("div",{className:"detail-meta-wrapper"},t.createElement("div",{className:"detail-meta"},t.createElement("p",{className:"detail-meta-label"},"本地开发目录"),t.createElement("p",{className:"detail-meta-value"},u),t.createElement("a",{onClick:function(){e.openProject(u)},href:"javascript:;",className:"detail-meta-upload-default"},"打开")),t.createElement("div",{className:"detail-meta "+(o?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最新更新时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastTestTime),t.createElement("a",{onClick:this.uploadForTest,href:"javascript:;",className:this.state.testBtnClass+"  "+(o?"detail-meta-upload-disabled":"")},this.state.testBtnTitle)),t.createElement("div",{className:"detail-meta "+(o?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最近上传时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastUploadTime),t.createElement("a",{onClick:this.upload,href:"javascript:;",className:"detail-meta-upload-default "+(o?"detail-meta-upload-default-disabled":"")},"上传")),t.createElement("div",{className:"detail-meta detail-meta-column"},t.createElement("label",{htmlFor:"es6toes5",onClick:this.onEs6Change,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:_}),t.createElement("i",null),"开启 ES6 转 ES5"),t.createElement("label",{htmlFor:"postcss",onClick:this.onPostCss,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:C}),t.createElement("i",null),"开启 上传代码时样式文件自动补全"),t.createElement("label",{htmlFor:"minified",onClick:this.onMinified,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:N}),t.createElement("i",null),"开启 代码压缩上传"),t.createElement("label",{htmlFor:"watcher",onClick:this.onAutoWatcher,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:S}),t.createElement("i",null),"监听文件变化，自动刷新开发者工具"),t.createElement("label",{htmlFor:"urlCheck",onClick:this.onUrlCheck,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:!T}),t.createElement("i",null),"开发环境不校验请求域名以及 TLS 版本")))),t.createElement("div",{className:"detail-opr-wrapper"},t.createElement("a",{onClick:this.delProject,href:"javascript:;",className:"button"},"删除项目"))),t.createElement(m,{show:1===v,project:this.props.project})),t.createElement(d,{ref:"uploadWnd",getResp:this.getResp,isTourist:o,project:this.props.project}),t.createElement("div",{className:"setting-show",style:f},t.createElement("div",{className:"setting-hd"},t.createElement("h3",{className:"setting-hd-title"},"预览")),t.createElement("div",{className:"setting-bd"},E,t.createElement("p",null,j)),t.createElement("div",{className:"setting-ft"},t.createElement("a",{href:"javascript:;",onClick:this.closeImg,className:"setting-button-default"},"确定"))))}});_exports=E}var _exports;init(),module.exports=_exports;