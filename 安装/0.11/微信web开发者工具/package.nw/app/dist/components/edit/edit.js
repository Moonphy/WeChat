"use strict";function init(){function e(e){return e.replace(/\\/g,"/")}function t(e){return{mtime:+e.mtime,birthtime:+e.birthtime,isDir:e.isDirectory(),size:e.size}}var r=require("glob"),s=require("fs"),i=require("path"),o=require("url"),n=require("rmdir"),a=require("../../lib/react.js"),c=require("../../cssStr/cssStr.js"),p=(require("../../actions/webviewActions.js"),require("../../actions/windowActions.js")),h=require("../../stores/windowStores.js"),u=(require("../../actions/projectActions.js"),require("../../weapp/utils/tools.js")),f=require("../../weapp/utils/projectManager.js"),l=require("../../stores/projectStores.js"),d=require("../../common/log/log.js"),m=require("child_process"),E=m.spawn,v=(m.spawnSync,m.exec,require("./utils/editTools.js")),w=require("./utils/grep.js"),_=require("./utils/formatCode.js"),g={},R=!1,S=("win32"===process.platform,{".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0}),b=function(e){p.showTipsMsg({msg:e,type:"error"})},j=function(e,t){p.showConfirm({content:e,callback:t})},N=a.createClass({displayName:"Edit",getInitialState:function(){return{project:this.props.project}},onMessage:function(a){var c=this,p=a.command,h=a.msg,d=a.ext,m=this.state.project;switch(p){case"GET_FILE_LIST":if(R)return;R=!0;var b=h.options,j=b.ignore||["node_modules/**/*","node_modules"];r("**",{cwd:m.projectpath,ignore:j},function(e,r){R=!1;for(var o={ret:e?e.toString():0,res:{files:e?[]:r,info:{}}},n=0;n<r.length;n++){var a=r[n],p=i.join(m.projectpath,a),h=s.lstatSync(p),u=h.isDirectory();u&&(r[n]=a+"/"),o.res.info[r[n]]=t(h)}r.forEach(function(e){g[e]=!0}),c.postMessage("webframe","RETURN_RES",o,d)});break;case"GET_FILE_DATA":var N=h.path,T=i.extname(N);if(S[T]){var y="";try{y=decodeURI(o.resolve(u.getBaseURL(m),N))}catch(I){y=o.resolve(u.getBaseURL(m),N)}this.postMessage("webframe","RETURN_RES",{ret:0,res:{data:y}},d)}else!function(){var e=i.join(m.projectpath,N);s.readFile(e,"utf8",function(r,i){var o=s.lstatSync(e),n=t(o),a={ret:r?r.toString():0,res:{data:r?"":i,info:n}};c.postMessage("webframe","RETURN_RES",a,d)})}();break;case"SAVE_FILE_DATA":var M=i.join(m.projectpath,h.path),W=h.data,D=void 0;try{s.writeFileSync(M,W,"utf8");var L=s.lstatSync(M),F=+L.mtime;if(g[e(h.path)]=F,D={ret:0,res:{path:h.path,info:t(L)}},"app.json"===h.path)try{var O=JSON.parse(W),A=O.pages||[];v.initPage(m,A)}catch(I){}}catch(C){D={ret:C.toString(),res:""}}this.postMessage("webframe","RETURN_RES",D,d);break;case"DEL_FILE":var U=h.path,k=void 0;try{s.unlinkSync(i.join(m.projectpath,U)),U=e(U),k={ret:0,res:U},delete g[U]}catch(C){k={ret:C.toString(),res:""}}this.postMessage("webframe","RETURN_RES",k,d);break;case"RENAME_FILE":var P=function(){var r=i.join(m.projectpath,h.oldPath),o=i.join(m.projectpath,h.newPath),n=void 0,a=s.lstatSync(r);if(a.isDirectory())!function(){f.manager.stopWatch();var e="darwin"===process.platform?"mv":"ren",s="darwin"===process.platform?['"'+r+'"','"'+o+'"']:['"'+r+'"','"'+i.relative(i.dirname(o),o)+'"'],p=[],u=[],l=E(e,s,{shell:!0});l.on("close",function(e){f.manager.restartWatch(),n=0===e?{ret:0,res:{path:h.newPath,info:t(a)}}:{ret:"目录修改错误",res:""},c.postMessage("webframe","RETURN_RES",n,d)}),l.stdout.on("data",function(e){p.push(e)}),l.stderr.on("data",function(e){u.push(e)})}();else{try{s.renameSync(r,o),delete g[e(h.oldPath)];var p=s.lstatSync(o);g[h.newPath]=!0,n={ret:0,res:{path:h.newPath,info:t(p)}}}catch(u){n={ret:u.toString(),res:""}}c.postMessage("webframe","RETURN_RES",n,d)}return"break"}();if("break"===P)break;case"RM_DIR":var q=function(){var t=m.projectpath,r=i.join(t,h.path);return n(r,function(r,s,o){r||(s.forEach(function(r){var s=i.relative(t,r);s=e(s),delete g[s]}),o.forEach(function(r){var s=i.relative(t,r);s=e(s),delete g[s]}));var n={ret:r?r.toString():0,res:r?"":s};c.postMessage("webframe","RETURN_RES",n,d)}),"break"}();if("break"===q)break;case"ADD_FILE":var B=i.join(m.projectpath,h.path),H=s.existsSync(B),x=void 0;if(H)x={ret:h.path+" already existed"},this.postMessage("webframe","RETURN_RES",x,d);else{try{s.writeFileSync(B,"","utf8"),g[e(h.path)]=!0;var G=s.lstatSync(B);x={ret:0,res:{path:h.path,info:t(G)}}}catch(C){x={ret:C.toString(),res:""}}this.postMessage("webframe","RETURN_RES",x,d)}break;case"MAKE_DIR":var J=i.join(m.projectpath,h.path),Q=void 0;try{s.mkdirSync(J),g[e(h.path)]=!0;var V=s.lstatSync(J);Q={ret:0,res:{path:J,info:t(V)}}}catch(C){Q={ret:C.toString(),res:""}}this.postMessage("webframe","RETURN_RES",Q,d);break;case"GET_PROJECT_INFO":this.postMessage("webframe","RETURN_RES",{ret:0,res:m},d);break;case"SET_EDIT_WEBVIEW":var z=h.editWebview;l.setProjectEditWebview(m.hash,z),this.postMessage("webframe","RETURN_RES",{ret:0,res:z},d);break;case"FIND_STR":var K=h.options,X=h.str,Y=K.cwd,Z=K.i,$=K.wholeword;Y=i.join(m.projectpath,Y),w({str:X,cwd:Y,i:Z,wholeword:$,project:m},function(e,t){var r={};e?r.ret=JSON.stringify(e):(r.ret=0,r.res=t),c.postMessage("webframe","RETURN_RES",r,d)});break;case"SHOW_ITEM_IN_FOLDER":var ee=i.join(m.projectpath,h.filePath);nw.Shell.showItemInFolder(ee);break;case"FORMAT_CODE":var te=h.code,re=h.options;_(te,re,function(e,t){var r={ret:0,res:t};c.postMessage("webframe","RETURN_RES",r,d)})}},postMessage:function(e,t,r,s){var i=this,o={to:e,msg:r,command:t,ext:s};return this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){i.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(o)):void this.msgQuery.push(o)},initport:function(e){var t=this;"edit"===e.name&&(this.port=e,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.port.onMessage.removeListener(t.onMessage),delete t.port,delete t.portID,t.msgQuery=[]}),this.postMessage("contentscript","SHAKE_HANDS",{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/editcontent.js"]},run_at:"document_start"}])},_windowFocus:function(){var e=this;if("focus"!==this.currentStatus){var t={eventType:"focus"};this.postMessage("webframe","WINDOW_CHANGE",t,{}),setTimeout(function(){e.webview.focus()},100),this.currentStatus="focus"}},_windowBlur:function(){if("blur"!==this.currentStatus){var e={eventType:"blur"};this.postMessage("webframe","WINDOW_CHANGE",e,{}),this.currentStatus="blur"}},_editWebview:function(e,t){e.hash===this.props.project.hash&&this.postMessage("webframe","WEBVIEW_SHOW_CHANGE",{editWebview:t},{})},_openProjectFile:function(e){this.postMessage("webframe","OPEN_FILE",e,{})},componentDidMount:function(){this.msgQuery=[],this.show=this.props.show;var e=this.refs.container,t=this.webview=document.createElement("webview");t.className="simulator-bd-webview_body",t.setAttribute("partition","persist:trusted"),t.setUserAgentOverride(t.getUserAgent()+" devtoolsedit"),e.appendChild(t),this.addContentScripts(),this.initRuntime(),t.addEventListener("dialog",function(e){var t=e.messageType||"",r=e.messageText,s=e.dialog;if("alert"===t)b(r);else if("confirm"===t)e.preventDefault(),j(r,function(e){e?s.ok():s.cancel()});else if("prompt"===t){var i=prompt(r);null!==i?s.ok(i):s.cancel()}});var r=f.manager;r.on("FILE_CHANGE",this._initWatcher),t.src="app/html/edit.html",h.on("WINDOW_BLUR",this._windowFocus),h.on("WINDOW_FOCUS",this._windowBlur),l.on("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),h.on("OPEN_PROJECT_FILE",this._openProjectFile)},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),h.removeListener("WINDOW_BLUR",this._windowFocus),h.removeListener("WINDOW_FOCUS",this._windowBlur),l.removeListener("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),h.removeListener("OPEN_PROJECT_FILE",this._openProjectFile);var e=f.manager;e.removeListener("FILE_CHANGE",this._initWatcher),this.webview.remove(),g={}},_initWatcher:function(r,s,o,n){if(r.hash===this.state.project.hash){var a=n?+n.mtime:0,c=n?t(n):{},p={};o=e(o);var h=(i.join(r.projectpath,o),g[o]);if("unlinkDir"===s&&(h=g[o+"/"]),"add"!==s&&"addDir"!==s||h)if("unlink"!==s&&"unlinkDir"!==s||!h){if("change"!==s)return void d.info("edit.js watch "+s);if(g[o]===a)return;g[o]=a,p={eventType:s,fileName:o,info:c}}else p={eventType:s,fileName:o,info:c},delete g[o];else p={eventType:s,fileName:o,info:c};this.postMessage("webframe","FILE_CHANGE",p,{})}},componentWillReceiveProps:function(e){"edit"===e.show?this._windowFocus():this._windowBlur()},render:function(){var e=this.props,t=e.show,r=(e.project,"edit"===t?{}:c.displayNone);return a.createElement("div",{className:"edit",ref:"container",style:r})}});_exports=N}var _exports;init(),module.exports=_exports;